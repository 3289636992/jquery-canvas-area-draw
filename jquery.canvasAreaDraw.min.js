(function(c){c.fn.canvasAreaDraw=function(c){this.each(function(h,e){t.apply(e,[h,e,c])})};var t=function(r,h,e){var b,k,f,d,m,l,p,q,n;r=c.extend({imageUrl:c(this).attr("data-image-url")},e);e=c(h).val().replace(/[^0-9\,]/ig,"");b=e.length?e.split(",").map(function(a){return parseInt(a,10)}):[];e=c('<button type="button" class="btn"><i class="icon-trash"></i>\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c</button>');f=c("<canvas>");d=f[0].getContext("2d");m=new Image;q=function(){f.attr("height",
    m.height).attr("width",m.width);l()};c(m).load(q);m.src=r.imageUrl;m.loaded&&q();f.css({background:"url("+m.src+")"});c(h).after("<br>",f,"<br>",e);p=function(a){a.offsetX||(a.offsetX=a.pageX-c(a.target).offset().left,a.offsetY=a.pageY-c(a.target).offset().top);b[k]=Math.round(a.offsetX);b[k+1]=Math.round(a.offsetY);l()};l=function(){d.canvas.width=d.canvas.width;n();if(!(2>b.length)){d.globalCompositeOperation="destination-over";d.fillStyle="rgb(255,255,255)";d.strokeStyle="rgb(255,20,20)";d.lineWidth=
    1;d.beginPath();d.moveTo(b[0],b[1]);for(var a=0;a<b.length;a+=2)d.fillRect(b[a]-2,b[a+1]-2,4,4),d.strokeRect(b[a]-2,b[a+1]-2,4,4),2<b.length&&1<a&&d.lineTo(b[a],b[a+1]);d.closePath();d.fillStyle="rgba(255,0,0,0.3)";d.fill();d.stroke()}};n=function(){c(h).val(b.join(","))};c(h).on("change",function(){var a=c(h).val().replace(/[^0-9\,]/ig,"");b=a.length?a.split(",").map(function(a){return parseInt(a,10)}):[];l()});c(document).find(e).click(function(){b=[];l()});c(document).find(f).on("mousedown",function(a){var d,
    e,f=b.length;if(3===a.which)return!1;a.preventDefault();a.offsetX||(a.offsetX=a.pageX-c(a.target).offset().left,a.offsetY=a.pageY-c(a.target).offset().top);d=a.offsetX;a=a.offsetY;for(var g=0;g<b.length;g+=2)if(e=Math.sqrt(Math.pow(d-b[g],2)+Math.pow(a-b[g+1],2)),6>e)return k=g,c(this).on("mousemove",p),!1;for(g=0;g<b.length;g+=2)1<g&&(e=u(d,a,b[g],b[g+1],b[g-2],b[g-1],!0),6>e&&(f=g));b.splice(f,0,Math.round(d),Math.round(a));k=f;c(this).on("mousemove",p);l();n();return!1});c(document).find(f).on("contextmenu",
    function(a){a.preventDefault();a.offsetX||(a.offsetX=a.pageX-c(a.target).offset().left,a.offsetY=a.pageY-c(a.target).offset().top);var d=a.offsetX;a=a.offsetY;for(var e=0;e<b.length;e+=2)if(dis=Math.sqrt(Math.pow(d-b[e],2)+Math.pow(a-b[e+1],2)),6>dis){b.splice(e,2);l();n();break}return!1});c(document).find(f).on("mouseup",function(){c(this).off("mousemove");n();k=null})};c(document).ready(function(){c(".canvas-area[data-image-url]").canvasAreaDraw()});var u=function(c,h,e,b,k,f,d){function m(b,c,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     d,a){return Math.sqrt((b-=d)*b+(c-=a)*c)}if(d&&!(d=function(b,c,d,a,e,f){if(!(e-d))return{x:d,y:c};if(!(f-a))return{x:b,y:a};var h,g=-1/((f-a)/(e-d));return{x:h=(e*(b*g-c+a)+d*(b*-g+c-f))/(g*(e-d)+a-f),y:g*h-g*b+c}}(c,h,e,b,k,f),d.x>=Math.min(e,k)&&d.x<=Math.max(e,k)&&d.y>=Math.min(b,f)&&d.y<=Math.max(b,f)))return e=m(c,h,e,b),c=m(c,h,k,f),e>c?c:e;d=b-f;var l=k-e;return Math.abs(d*c+l*h+(e*f-b*k))/Math.sqrt(d*d+l*l)}})(jQuery);
